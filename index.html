<!DOCTYPE html>
<html>
<head>
    <style>
        #pngTuber {
            width: 400px;
            height: auto;
            /* Изменено: перемещаем в правый нижний угол */
            position: fixed; /* Фиксируем позицию */
            right: 20px; /* Отступ от правого края */
            bottom: 20px; /* Отступ от нижнего края */
            z-index: 1000; /* Поверх других элементов */
            transition: transform 0.2s ease;
        }
        
        /* Для адаптивности на мобильных устройствах */
        @media (max-width: 768px) {
            #pngTuber {
                width: 250px; /* Меньше на мобилках */
                right: 10px;
                bottom: 10px;
            }
        }
        
        /* Стиль для тестовой кнопки (опционально) */
        .test-button {
            position: fixed;
            left: 20px;
            top: 20px;
            padding: 10px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
        }
    </style>
</head>
<body>
    <!-- Тестовая кнопка для проверки (можно удалить) -->
    <button class="test-button" onclick="testAnimation()">Тест анимации</button>
    
    <!-- PNG моделька -->
    <img id="pngTuber" src="talking.png">
    
    <script>
        const pngTuber = document.getElementById('pngTuber');
        let isTalking = false;
        let audioContext = null;
        let analyser = null;
        let microphone = null;

        // Функция для инициализации аудио
        async function initAudio() {
            try {
                // Запрос разрешения на микрофон
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: false
                    } 
                });
                
                // Создаем аудиоконтекст
                audioContext = new AudioContext();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                
                // Настройки анализатора
                analyser.fftSize = 256;
                analyser.smoothingTimeConstant = 0.8;
                
                // Подключаем
                microphone.connect(analyser);
                
                // Запускаем анализ
                analyzeAudio();
                
                console.log('Микрофон активирован. PNG моделька в правом нижнем углу.');
                
            } catch (error) {
                console.error('Ошибка доступа к микрофону:', error);
                // Фолбэк - имитация звука для тестирования
                simulateAudio();
            }
        }

        // Функция анализа аудио
        function analyzeAudio() {
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            function checkAudio() {
                analyser.getByteFrequencyData(dataArray);
                
                // Вычисляем средний уровень звука
                let sum = 0;
                for (let i = 0; i < dataArray.length; i++) {
                    sum += dataArray[i];
                }
                const average = sum / dataArray.length;
                
                // Порог чувствительности (можно регулировать)
                const threshold = 20;
                
                // Реакция на звук
                if (average > threshold && !isTalking) {
                    // Есть звук - поднимаем вверх
                    pngTuber.style.transform = 'translateY(-20px) scale(1.05)';
                    pngTuber.src = 'talking.png';
                    isTalking = true;
                } else if (average <= threshold && isTalking) {
                    // Нет звука - возвращаем на место
                    pngTuber.style.transform = 'translateY(0px) scale(1)';
                    pngTuber.src = 'talking.png';
                    isTalking = false;
                }
                
                requestAnimationFrame(checkAudio);
            }
            
            checkAudio();
        }

        // Функция для тестирования без микрофона
        function simulateAudio() {
            let simulatedTalking = false;
            
            setInterval(() => {
                // Случайным образом имитируем речь
                if (Math.random() > 0.7 && !simulatedTalking) {
                    pngTuber.style.transform = 'translateY(-20px) scale(1.05)';
                    pngTuber.src = 'talking.png';
                    simulatedTalking = true;
                    console.log('Тест: говорим');
                } else if (Math.random() > 0.8 && simulatedTalking) {
                    pngTuber.style.transform = 'translateY(0px) scale(1)';
                    pngTuber.src = 'talking.png';
                    simulatedTalking = false;
                    console.log('Тест: молчим');
                }
            }, 500);
        }

        // Функция теста анимации (для кнопки)
        function testAnimation() {
            pngTuber.style.transform = 'translateY(-20px) scale(1.05)';
            setTimeout(() => {
                pngTuber.style.transform = 'translateY(0px) scale(1)';
            }, 1000);
            console.log('Тест анимации выполнен');
        }

        // Запускаем при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Ждем немного перед инициализацией
            setTimeout(initAudio, 1000);
            
            // Информация о расположении
            console.log('PNG моделька расположена в правом нижнем углу экрана');
        });

        // Обработчик клика для ручной активации (требуется в некоторых браузерах)
        document.body.addEventListener('click', function() {
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
                console.log('Аудио контекст возобновлен');
            }
        });
        
        // Обработчик изменения размера окна (для отладки)
        window.addEventListener('resize', function() {
            console.log('Размер окна:', window.innerWidth, 'x', window.innerHeight);
        });
    </script>
</body>
</html>
